name: CI
on: [push]
jobs:
  unit_test_flutter:
    runs-on: ubuntu-latest
    steps:
      - name: Clone repository
        uses: actions/checkout@v4
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: 3.22.2
      - run: flutter --version

      - name: Run unit tests for Flutter plugin
        run: flutter test

      - name: Run unit tests for example app
        run: |
          cd example
          flutter test

  unit_test_android:
    runs-on: ubuntu-latest
    steps:
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: 3.22.2
      - run: |
          flutter --version
          flutter pub get
          cd example
          flutter pub get
          cd ..

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Create mock Firebase configuration
        run: |
          mkdir -p example/lib
          echo "class DefaultFirebaseOptions { static get currentPlatform => null; }" > example/lib/firebase_options.dart

      - name: Modify main.dart for testing
        run: |
          sed -i '1i import "dart:io" show Platform;' example/lib/main.dart
          sed -i 's/import "firebase_options.dart"/if (!Platform.environment.containsKey("FLUTTER_TEST")) import "firebase_options.dart"/' example/lib/main.dart
          sed -i 's/Firebase.initializeApp/if (!Platform.environment.containsKey("FLUTTER_TEST")) Firebase.initializeApp/' example/lib/main.dart

      - name: Create local.properties
        run: |
          echo "sdk.dir=${{ env.ANDROID_SDK_ROOT }}" > example/android/local.properties
          echo "flutter.minSdkVersion=29" >> example/android/local.properties
          echo "flutter.compileSdkVersion=33" >> example/android/local.properties
          echo "flutter.targetSdkVersion=33" >> example/android/local.properties

      # Execute unit tests
      - name: Unit Test
        env:
          ANDROID_HOME: ${{ env.ANDROID_SDK_ROOT }}
          FLUTTER_TEST: true
        run: |
          cd example/android
          ./gradlew testDebugUnitTest --stacktrace --info

      - name: Android Test Report
        uses: asadmansr/android-test-report-action@v1.2.0
        if: ${{ always() }} # IMPORTANT: run Android Test Report regardless